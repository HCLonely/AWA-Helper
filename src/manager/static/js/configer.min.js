(async()=>{$(document).ready(()=>{$(window).scroll(function(){50<$(this).scrollTop()?$("#back2top").fadeIn():$("#back2top").fadeOut()}),$("#back2top").click(()=>(document.body.scrollIntoView(),!1)),new bootstrap.Tooltip($("#back2top")[0])});var e="/js/template.yml",[e]=(a(decodeURIComponent(e)),$("#file-selector"));async function a(e){e=new URL(e,location.href);e.search?e.search+="&time="+Date.now():e.search+="?time="+Date.now();const t=new bootstrap.Modal("#modal-loading");t.show();var[e,a]=await axios.get(e.href,{validateStatus:e=>200<=e&&e<400}).then(e=>[!0,e.data]).catch(e=>(console.error(e),[!1,e])),[n]=$("#modal-loading");n.addEventListener("shown.bs.modal",()=>{t.hide()}),t.hide(),e?r(a):i(a.message,"Get template file failed!")}async function r(e){e=function(e){try{var t=jsyaml.load(e);if(console.log(t),!Array.isArray(t))return i("The root template must be an array!"),!1;for(let e=0;e<t.length;e++){if(!t[e].name)return i(`The template of No.${e+1} has no the key: "name".`),!1;if(!t[e].body)return i(`The template of No.${e+1} has no the key: "body".`),!1;if(!t[e].type&&!t[e].filename)return i(`The template of No.${e+1} has no the keys: "type", "filename".
You have to input at least one of them.`),!1}return console.log(n(t)),n(t)}catch(e){return console.error(e),i(e.message),!1}}(e);if(e){const t=await(!!localStorage?.managerServerSecret&&axios.post("/getConfig",{secret:localStorage.managerServerSecret}).then(async e=>{if(console.log(e),200===e.status)try{return jsyaml.load(e.data)}catch(e){}return!1}).catch(e=>(console.error(e),!1)));$("#file-selector,#loadRemoteFileLabel,#loadRemoteFileInput").hide(),e.forEach((a,e)=>{t&&(a.body=function i(e,o){return Object.fromEntries(Object.entries(e).map(([t,a])=>{if(o[t]||!(o[t]??!0))if("object"!=typeof o[t]||Array.isArray(o[t]))if(["artifacts"].includes(t)){const n=JSON.stringify(a.body[0]);for(let e=0;e<o[t].length;e++){const r=JSON.parse(n);r.body=JSON.parse(JSON.stringify(i(r.body,o[t][e]))),a.body[e]=r}}else null===o[t]&&Array.isArray(a.defaultValue)?a.defaultValue=[]:a.defaultValue=o[t],a.bindValue&&(a.bindValue.body[a.defaultValue]=i(a.bindValue.body[a.defaultValue],o));else a.body=i(a.body,o[t]);return[t,a]}))}(a.body,t)),$("div.container").append(`<form id="config-${p(a.name).replace(/[,./;'[\]\\<>?:"{}|`~!@#$%^&*()+=\s]/gi,"")}" style="display:none;" data-type="${a.type||a.filename.split(".").slice(0,-1).join(".")}" data-filename="${a.filename||a.name+"."+a.type}">
        ${a.quote?`<figure class="text-center" style="border: 1px dashed #00c9ff;border-radius: 5px;">
          <blockquote class="blockquote">
            <p>${a.quote}</p>
          </blockquote>
          ${a.author?`<figcaption class="blockquote-footer" style="margin-bottom: .5rem;">${a.author}</figcaption>`:""}
        </figure>`:""}
      </form>`),0===e&&($("#single-config-name>button").attr("data-name",p(a.name)),$("#single-config-name>button").text(p(a.name)),$("#config-"+p(a.name).replace(/[,./;'[\]\\<>?:"{}|`~!@#$%^&*()+=\s]/gi,"")).show());e=$(`<li><a class="dropdown-item${0===e?" active":""}" href="javascript:void(0);">${a.name}</a></li>`);e.click(function(){var e=$(this).text().trim();$("#single-config-name>button").attr("data-name",e),$("#single-config-name>button").text(e),$("#single-config-name li>a").removeClass("active"),$(this).children("a").addClass("active"),$("form").hide(),$("#config-"+e.replace(/[,./;'[\]\\<>?:"{}|`~!@#$%^&*()+=\s]/gi,"")).show()}),$("#single-config-name>ul").append(e),Object.entries(a.body).forEach(([e,t])=>{!function n(r,i,o,e,t,a){const l=r+"-"+i;if("text"===o.type)return"textarea"===o.inputType?void $("#config-"+r).append(`<div class="mb-3" ${"single-select"===e?` style="display: none;" bind-name="${t}" bind-value="${a}"`:""}>
          <label for="${l}" class="form-label">
            ${o.name||i}${o.required?'<font style="color:red;" title="Required">*</font>':""}
            ${""+o.validation?'<font style="color:blue;" title="RegExp Validation">!</font>':""}
            ${"array"===e&&!0===o.repeat?`<button type="button" class="btn btn-outline-primary repeat"
            data-id="${l}" data-name="${i}"
            style="--bs-btn-padding-y: 0rem; --bs-btn-padding-x: .3rem;--bs-btn-font-size: .55rem;border-radius: 50%;margin-left: .5rem;">+</button>`:""}
          </label>
          <textarea type="text" class="form-control item" id="${l}" name="${i}" data-parent="${r}"
            ${o.desp?` aria-describedby="help-${l}"`:""}
            ${o.placeholder?` placeholder="${o.placeholder}"`:""}
            ${o.required?" required":""}
            ${""+(o.defaultValue??"")?` value="${o.defaultValue}"`:""}
            ${o.validation?` data-validation="${o.validation}"`:""}
          ></textarea>
          ${o.validation?'<div class="invalid-feedback">Invalid format!</div>':""}
          ${o.desp?`<div id="help-${l}" class="form-text">${o.desp}</div>`:""}
        </div>`):void $("#config-"+r).append(`<div class="mb-3" ${"single-select"===e?` style="display: none;" bind-name="${t}" bind-value="${a}"`:""}>
        <label for="${l}" class="form-label">${o.name||i}${o.required?'<font style="color:red;" title="Required">*</font>':""}
            ${o.validation?'<font style="color:blue;" title="RegExp Validation">!</font>':""}
            ${"array"===e&&!0===o.repeat?`<button type="button"
          class="btn btn-outline-primary repeat" data-id="${l}" data-name="${i}"
          style="--bs-btn-padding-y: 0rem; --bs-btn-padding-x: .3rem;--bs-btn-font-size: .55rem;border-radius: 50%;margin-left: .5rem;">+</button>`:""}
        </label>
        <input type="${o.inputType||"text"}" class="form-control" id="${l}" name="${i}" data-parent="${r}"
          ${o.desp?` aria-describedby="help-${l}"`:""}
          ${o.placeholder?` placeholder="${o.placeholder}"`:""}
          ${o.required?" required":""}
          ${""+(o.defaultValue??"")?` value="${o.defaultValue}"`:""}
          ${o.validation?` data-validation="${o.validation}"`:""}
        />
        ${o.validation?'<div class="invalid-feedback">Invalid format!</div>':""}
        ${o.desp?`<div id="help-${l}" class="form-text">${p(o.desp)}</div>`:""}
      </div>`);if("boolean"===o.type)return void $("#config-"+r).append(`<div class="form-check form-switch mb-3" ${"single-select"===e?` style="display: none;" bind-name="${t}" bind-value="${a}"`:""}>
        <input class="form-check-input" type="checkbox" role="switch" id="${l}" name="${i}" data-parent="${r}"
          ${o.desp?` aria-describedby="help-${l}"`:""}
          ${o.defaultValue?' checked="checked"':""}
          />
        <label class="form-check-label" for="${l}">${o.name||i}${"array"===e&&!0===o.repeat?`<button type="button"
          class="btn btn-outline-primary repeat" data-id="${l}" data-name="${i}"
          style="--bs-btn-padding-y: 0rem; --bs-btn-padding-x: .3rem;--bs-btn-font-size: .55rem;border-radius: 50%;margin-left: .5rem;">+</button>`:""}
        </label>
        ${o.desp?`<div id="help-${l}" class="form-text">${o.desp}</div>`:""}
      </div>`);if("single-select"===o.type){if($("#config-"+r).append(`<div class="mb-3" ${"single-select"===e?` style="display: none;" bind-name="${t}" bind-value="${a}"`:""}>
        <label class="form-select-label" for="${l}">${o.name||i}${"array"===e&&!0===o.repeat?`<button type="button"
          class="btn btn-outline-primary repeat" data-id="${l}" data-name="${i}"
          style="--bs-btn-padding-y: 0rem; --bs-btn-padding-x: .3rem;--bs-btn-font-size: .55rem;border-radius: 50%;margin-left: .5rem;">+</button>`:""}
        </label>
        <select class="form-select" id="${l}" name="${i}" data-parent="${r}"
        ${o.desp?` aria-describedby="help-${l}"`:""}>
          ${o.options.map((e,t)=>`<option value="${e}" ${e===o.defaultValue?" selected":""}>
          ${o.optionsName?.[t]?o.optionsName[t]:e}</option>`).join("")}
        </select>
        ${o.desp?`<div id="help-${l}" class="form-text">${o.desp}</div>`:""}
      </div>`),o.bindValue){if(o.bindValue.isChildren){$("#"+l).data("bindData",o.bindValue.body),$("#"+l).change(function(){$(`#config-${r} [bind-value="${i}"]`).remove();const e=$(this).data("bindData")[$(this).val()];e&&(Object.entries(e).forEach(([e,t])=>{n(r,e,t,o.type,"",i)}),$(`#config-${r} [bind-value="${i}"]`).show())});const s=o.bindValue.body[o.defaultValue];return void(s&&(Object.entries(s).forEach(([e,t])=>{n(r,e,t,o.type,"",i)}),$(`#config-${r} [bind-value="${i}"]`).show()))}$("#"+l).data("bindData",o.bindValue.body),$("#"+l).change(function(){$(`#config-${r} [bind-name="${i}"]`).hide(),$(`#config-${r} [bind-value="${$(this).val()}"]`).show()}),Object.entries(o.bindValue.body).forEach(([a,e])=>{Object.entries(e).forEach(([e,t])=>{n(r,e,t,o.type,i,a)})});const d=o.bindValue.body[o.defaultValue];d&&$(`#config-${r} [bind-value="${o.defaultValue}"]`).show()}return}if("multi-select"===o.type)return void $("#config-"+r).append(`<div class="mb-3" ${"single-select"===e?` style="display: none;" bind-name="${t}" bind-value="${a}"`:""}>
        <label class="form-select-label" for="${l}">${o.name||i}${"array"===e&&!0===o.repeat?`<button type="button"
          class="btn btn-outline-primary repeat" data-id="${l}" data-name="${i}"
          style="--bs-btn-padding-y: 0rem; --bs-btn-padding-x: .3rem;--bs-btn-font-size: .55rem;border-radius: 50%;margin-left: .5rem;">+</button>`:""}
        </label>
        <select class="form-select" id="${l}" name="${i}" multiple data-parent="${r}"
        ${o.desp?` aria-describedby="help-${l}"`:""}>
          ${o.options.map((e,t)=>`<option value="${e}"
          ${(o.defaultValue||[]).includes(e)?" selected":""}>
          ${o.optionsName?.[t]?o.optionsName[t]:e}</option>`).join("")}
        </select>
        ${o.desp?`<div id="help-${l}" class="form-text">${o.desp}</div>`:""}
      </div>`);"object"===o.type&&($("#config-"+r).append(`<div class="card card-body" style="padding-bottom:0;margin-bottom:1rem;${"single-select"===e?"display: none;":""}"
      ${"single-select"===e?` bind-name="${t}" bind-value="${a}"`:""}>
        <p style="text-align:center;margin-bottom:0;"">
          <a class="btn btn-primary" data-bs-toggle="collapse" href="#config-${r}-${i}" role="button" aria-expanded="true"
            aria-controls="config-${r}-${i}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-custom-class="custom-tooltip"
            data-bs-title="Click to hide/show the options about ${o.name||i}.">
            ${o.name||i}
          </a>
          ${"array"===e&&!0===o.repeat?`<button type="button" class="btn btn-outline-primary delete-repeat"
            data-id="config-${r}-${i}" data-name="${i}"
            style="--bs-btn-padding-y: 0rem; --bs-btn-padding-x: .3rem;--bs-btn-font-size: .55rem;border-radius: 50%;margin-left: .5rem;width: 37px;">-</button><button type="button" class="btn btn-outline-primary repeat"
            data-id="config-${r}-${i}" data-name="${i}"
            style="--bs-btn-padding-y: 0rem; --bs-btn-padding-x: .3rem;--bs-btn-font-size: .55rem;border-radius: 50%;margin-left: .5rem;">+</button>`:""}
          ${o.desp?`<div id="configHelp-${r}-${i}" class="form-text">${o.desp}</div>`:""}
        </p><div id="config-${r}-${i}" class="collapse show" name="${i}" type="object" data-parent="${r}"></div>

      </div>`),Object.entries(o.body).forEach(([e,t])=>{n(r+"-"+i,e,t,o.type)}));if("array"===o.type){$("#config-"+r).append(`<div class="card card-body" style="padding-bottom:0;margin-bottom:1rem;${"single-select"===e?"display: none;":""}"
      ${"single-select"===e?` bind-name="${t}" bind-value="${a}"`:""}>
        <p style="text-align:center;margin-bottom:0;">
          <a class="btn btn-primary" data-bs-toggle="collapse" href="#config-${r}-${i}" role="button" aria-expanded="true"
            aria-controls="config-${r}-${i}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-custom-class="custom-tooltip"
            data-bs-title="Click to hide/show the options about ${o.name||i}.">
            ${o.name||i}
          </a>
          ${"array"===e&&!0===o.repeat?`<button type="button" class="btn btn-outline-primary delete-repeat"
            data-id="config-${r}-${i}" data-name="${i}"
            style="--bs-btn-padding-y: 0rem; --bs-btn-padding-x: .3rem;--bs-btn-font-size: .55rem;border-radius: 50%;margin-left: .5rem;width: 37px;">-</button><button type="button" class="btn btn-outline-primary repeat"
            data-id="config-${r}-${i}" data-name="${i}"
            style="--bs-btn-padding-y: 0rem; --bs-btn-padding-x: .3rem;--bs-btn-font-size: .55rem;border-radius: 50%;margin-left: .5rem;">+</button>`:""}
          ${o.desp?`<div id="configHelp-${r}-${i}" class="form-text">${o.desp}</div>`:""}
        </p><div id="config-${r}-${i}" class="collapse show" name="${i}" type="array" data-parent="${r}"></div>
      </div>`);const c=[];o.body.forEach(e=>{"number"==typeof e.repeat&&0<e.repeat?c.push(...new Array(e.repeat).fill(e)):c.push(e)}),c.forEach((e,t)=>{n(r+"-"+i,t,e,o.type)})}}(p(a.name).replace(/[,./;'[\]\\<>?:"{}|`~!@#$%^&*()+=\s]/gi,""),e,t)})}),$("button.repeat").on("click",l),$("button.delete-repeat").on("click",e=>{1<$(e.target).parent().parent().parent().children().length?$(e.target).parent().parent().remove():$(e.target).parent().parent().find("input").val("")});e=$('<button class="btn btn-primary" type="submit" style="margin-bottom: 1rem;">Save</button>');$("form").append(e).submit(async function(t){$(this).children('button[type="submit"]').attr("disabled","disabled").html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>Loading...'),t.target.checkValidity()||($(this).children('button[type="submit"]').text("Save").removeAttr("disabled"),t.stopPropagation()),t.preventDefault();t=$(this);for(const e of $.makeArray(t.find("[data-validation]")))$(e).removeClass("is-invalid").removeClass("is-valid"),new RegExp($(e).attr("data-validation")).test($(e).val())||$(e).addClass("is-invalid");if(0<t.find(".is-invalid[data-validation]").length)$(this).children('button[type="submit"]').text("Save").removeAttr("disabled"),t.find(".is-invalid[data-validation]")[0].scrollIntoView({behavior:"smooth"});else{var a=function n(e,r){const i=r?[]:{};e.find(`[data-parent="${e.attr("id").replace("config-","")}"]:visible`).map((e,t)=>{if("object"===$(t).attr("type"))r?i.push(n($(t))):i[$(t).attr("name")]=n($(t));else if("array"===$(t).attr("type")){const a=n($(t),!0);r?i.push(a):i[$(t).attr("name")]=a}else"checkbox"===$(t).attr("type")?r?i.push($(t).prop("checked")):i[$(t).attr("name")]=$(t).prop("checked"):"number"===$(t).attr("type")?r?i.push(parseFloat($(t).val(),10)):i[$(t).attr("name")]=parseFloat($(t).val(),10):r?i.push($(t).val()):i[$(t).attr("name")]=$(t).val();return t});return i}(t);let e="";console.log(a),"json"===t.attr("data-type")&&(e=JSON.stringify(a,null,2)),["yml","yaml"].includes(t.attr("data-type"))&&(e=jsyaml.dump(a,{lineWidth:-1,forceQuotes:!0})),["ini"].includes(t.attr("data-type"))&&(e=function a(e,n=""){return Object.entries(e).map(([e,t])=>"object"==typeof t?a(t,""+n+e+"."):""+n+e+"="+t).join("\n")}(a)),t=e,await(!!localStorage?.managerServerSecret&&axios.post("/setConfig",{secret:localStorage.managerServerSecret,config:t}).then(async e=>{var t,a;return console.log(e),200===e.status?(t="Success",a="",$("#modalLabel").html('<span class="badge rounded-pill text-bg-danger">Info</span>'+(a||"Info")),$("#modalBody>textarea").val(t),new bootstrap.Modal("#modal").show(),!0):(i(e.status),!1)}).catch(e=>(i(e.message),console.error(e),!1))),$(this).children('button[type="submit"]').text("Save").removeAttr("disabled")}})}}function l(e){e=$(e.target).parent().parent();const n=e.children("div.collapse").attr("name"),i=e.parent().children().length,o=[new RegExp(n+"$"),i];var t=$(e.prop("outerHTML"));t.children().map((e,t)=>{var a=$(t).attr("id"),a=(a&&$(t).attr("id",a.replace(...o)),$(t).attr("name"));return a&&$(t).attr("name",i),t}),t.children("p").children("a").map((e,t)=>{var a=$(t).attr("href"),a=(a&&$(t).attr("href",a.replace(...o)),$(t).attr("aria-controls"));return a&&$(t).attr("aria-controls",a.replace(...o)),t}),t.children("p").children("button").map((e,t)=>{var a=$(t).attr("data-id"),a=(a&&$(t).attr("data-id",a.replace(...o)),$(t).attr("data-name"));return a&&$(t).attr("data-name",i),t}),t.children("div.collapse").children().map((e,t)=>{var a=$(t).children("[name]").attr("name");const r=[new RegExp(n+`-${a}$`),i+"-"+a];return $(t).children().map((e,t)=>{var a=$(t).attr("id"),n=(a&&$(t).attr("id",a.replace(...r)),$(t).attr("data-parent")),n=(n&&$(t).attr("data-parent",n.replace(...o)),$(t).attr("for")),n=(n&&$(t).attr("data-parent",n.replace(...r)),$(t).attr("aria-describedby"));return n&&$(t).attr("aria-describedby",a.replace(...r)),t}),t}),t.children().children("button.repeat").map((e,t)=>{var a=$(t).clone();return a.removeClass("repeat").addClass("delete-repeat").text("-").attr("style","--bs-btn-padding-y: .02rem; --bs-btn-padding-x: .39rem;--bs-btn-font-size: .55rem;border-radius: 50%;margin-left: .5rem;width: 37px;"),$(t).prev().hasClass("delete-repeat")&&$(t).prev().remove(),$(t).before(a),t}),t.children().children().children("input").attr("value",""),e.after(t.prop("outerHTML")),$("button.delete-repeat").off("click").on("click",e=>{1<$(e.target).parent().parent().parent().children().length?$(e.target).parent().parent().remove():$(e.target).parent().parent().find("input").val("")}),$("button.repeat").off("click",l).on("click",l)}function n(e){return Array.isArray(e)?e.map(e=>"string"==typeof e?o(e):e&&"object"==typeof e?n(e):e):Object.fromEntries(Object.entries(e).map(([e,t])=>"string"==typeof t?[o(e),o(t)]:t&&"object"==typeof t?[o(e),n(t)]:[o(e),t]))}function i(e,t=""){$("#modalLabel").html('<span class="badge rounded-pill text-bg-danger">Error</span>'+(t||"")),$("#modalBody>textarea").val(e),new bootstrap.Modal("#modal").show()}function t(n){return new Promise((t,e)=>{var a=new FileReader;a.addEventListener("error",()=>{console.error("Error occurred reading file: "+n.name),e("Error occurred reading file: "+n.name)}),a.addEventListener("load",e=>{t(e.target.result)}),a.readAsText(n)})}function o(e){return 0===e.length?"":e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&apos;").replace(/"/g,"&quot;")}function p(e){return 0===e.length?"":e.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&apos;/g,"'").replace(/&quot;/g,'"')}e.addEventListener("dragover",e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}),e.addEventListener("drop",async e=>{e.stopPropagation(),e.preventDefault();var e=e.dataTransfer.files;0<e.length&&((e=await t(e[0]).then(e=>e).catch(e=>(console.log(e),i(e),!1)))?r(e):i("The file content is empty!"))}),$("#readTemplateFile")[0].addEventListener("change",async e=>{0!==e.target.files.length&&((e=await t(e.target.files[0]).then(e=>e).catch(e=>(console.error(e),i(e),!1)))?r(e):i("The file content is empty!"))}),$("#loadRemoteFile").click(async e=>{var t=$("#remote-url").val();t&&($(e.target).attr("disabled","disabled").html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>Loading...'),await a(t),$(e.target).text("Save").removeAttr("disabled"))})})();